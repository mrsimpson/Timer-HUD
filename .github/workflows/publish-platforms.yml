name: Publish to Mod Platforms

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.6'

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v3

      - name: Display environment for publishing
        run: |
          echo "Java version:"
          java -version
          echo "Gradle version:"
          ./gradlew --version
          echo "Release: ${{ github.event.release.tag_name }}"

      - name: Build for publishing
        run: ./gradlew build --no-daemon --info

      - name: Verify publishing artifacts
        run: |
          echo "JARs available for publishing:"
          ls -la build/libs/
          echo "Release prerelease status: ${{ github.event.release.prerelease }}"

      # Publish to CurseForge (requires CURSEFORGE_TOKEN secret)
      - name: Publish to CurseForge
        if: ${{ !github.event.release.prerelease }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          curseforge-id: YOUR_CURSEFORGE_PROJECT_ID  # Replace with your project ID
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

          name: Enhanced Timer HUD ${{ github.event.release.tag_name }}
          version: ${{ github.event.release.tag_name }}
          changelog: ${{ github.event.release.body }}

          loaders: fabric
          game-versions: "1.21.1"
          dependencies: |
            fabric-api(required){modrinth:P7dR8mSH}{curseforge:306612}

      # Publish to Modrinth (requires MODRINTH_TOKEN secret)
      - name: Publish to Modrinth
        if: ${{ !github.event.release.prerelease }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: YOUR_MODRINTH_PROJECT_ID  # Replace with your project slug
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          name: Enhanced Timer HUD ${{ github.event.release.tag_name }}
          version: ${{ github.event.release.tag_name }}
          changelog: ${{ github.event.release.body }}

          loaders: fabric
          game-versions: "1.21.1"
          dependencies: |
            fabric-api(required){modrinth:P7dR8mSH}{curseforge:306612}